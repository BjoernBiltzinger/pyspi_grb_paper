% Define document class
\documentclass[twocolumn]{aa}

% Filler text
\usepackage{caption}
\usepackage{subcaption}
\usepackage{float}
%\usepackage{natbib}
% Begin!
\begin{document}

% Title
\title{Fitting Synchrotron Models to Gamma-Ray Burst Data from INTEGRAL/SPI}

% Author list
\author{
  BjÃ¶rn Biltzinger
  \and
  Jochen Greiner
  \and
  Michael Burgess
  \and
  Siegert
}

\institute{Max-Planck-Institut fur extraterrestrische Physik, Giessenbachstrasse 1, D-85748 Garching, Germany \label{mpe}}
\date{Received 18 December, 2019; accepted 22 May, 2020}

\label{firstpage}
% Abstract with filler text
\abstract {
  In the last years it has been shown, that it is needed to fit physical models to Gamma-Ray Burst (GRB) data to get more insights into their emission mechanism. For the energy range between ~ 10 keV to ~ 10 MeV Fermi/GBM has been the main instrument to analyze GRBs. In this paper we show how we can add INTEGRAL/SPI to this analysis. INTEGRAL/SPI covers a similar energy range like Fermi/GBM and has a very good energy resolution of 2.2 keV at 1.3 MeV. Therefore INTEGRAL/SPI is an ideal instrument to precisely measure the curvature of the spectrum. We present PySPI, a new analysis software we developed to analyze GRB data from SPI, and apply it to the GRB 120711A. We show that PySPI improves the analysis of SPI data, for GRBs, compared to the official analysis software and that the GBM and the SPI data of this GRB can be fitted well with a physical synchrotron model and that combining both, reduces the allowed parameter space. This demonstrates that SPI can play an important role in GRB model fitting.
}

\keywords{ (stars:) gamma ray bursts -- methods: data analysis --
  methods: statistical}

\maketitle

% Main body with filler text
\section{Introduction}
Gamma-Ray Bursts (GRBs) are short transient bursts of gamma rays, with a typical active time range between a few ms and few hundred seconds for the prompt phase, which is mostly observed in X- and Gamma-Rays. After the prompt emission, there is a long lasting afterglow phase when the ejecta interacts with the Inter Stellar Medium (ISM). Long GRBs ($\approx$> 2s) have been associated to the collapse of massive stars, whereas short GRBs are believed to be caused by mergers of compact objects, like Neutron Stars. In both cases it is commonly agreed on, that the progenitor events of GRBs produce jetted relativistic outflows, which consists of several shells with different velocities, resulting in internal shell collisions. But it is still highly debated what the exact emission mechanism of the Gamma-Rays is. \citep{gamma-ray-burst, gw}

In the past, GRB data was often fitted with empirical function like the Band function (cite band). But in recent years it has been shown, that this approach can be misleading and that one should rather fit physical models directly to the data. An example for this is the so-called line-of-death for synchrotron emission, which states that synchrotron radiation can not be the emission mechanism, if fits with a Band function give a low energy power law slope larger than -2/3. \citep{line-of-death, line-of-death2}
\citet{synch} have shown that this conclusion is not correct and that you can fit GRB spectra well with a physical synchrotron model even though the same spectra violate the line-of-death if fitted with a Band function.

The Gamma-Ray Burst Monitor (GBM) onboard of the Fermi satellite is often used to fit GRB data in the 8 keV to 10 MeV energy range. GBM consists of 12 NaI and two BGO scintillator detectors and is an all-sky instrument, that observes the whole sky, except the part that is occulted by the Earth at that time. (cite)
%The problem with fitting empirical models to the data and using the individual parameters of these fits to construct constrains on the physics is that the
Another instrument that operates in a similar energy range is the SPectrometer on INTEGRAL (SPI), which is one of the instruments onboard of the INTErnational Gamma-Ray Astrophysics Laboratory (INTEGRAL) satellite, that was launched in 2002 and is still operating today. SPI is a coded mask instrument, which has a fully coded FOV of 16 degrees and covers an energy range between 20 keV and 8 MeV. Due to the Germanium detectors it has a very good energy resolution of roughly 2.2 keV at 1.3 MeV, which allows the identification of fine features, like atomic decay lines \citep{spi}. In the case of GRBs this excellent energy resolution could allow us to determine the curvature of the spectra with an unmet precision. This is the main motivation to use SPI in our analysis.

Several works have used SPI data to fit GRB models \citep{spi_grb1, spi_grb2}, but all of them fitted empirical models like the Band function. To allow us to fit physical models and to improve the analysis methods we developed PySPI, which will be explained in detail in \ref{pyspi}.

%The other instrument that we use in this work is the Gamma-Ray Burst Monitor (GBM) onboard of the Fermi satellite. GBM is an all-sky instrument, that observes the whole sky, except the part that is occulted by the Earth at that time. It consists of 12 NaI and two BGO scintillator detectors that cover in total an energy range between 8 keV and 10 MeV. (cite)

\section{Methods}
\subsection{PySPI}
\label{pyspi}
To fit the SPI data of GRBs, we developed a new python package PySPI (ref to JOSS?), which is an open source analysis tool. In the following we will summarize the main points of PySPI.

\subsubsection*{Background}

GRBs are transient sources with a typical duration only up to a few tens of seconds. Therefore we can use the time intervals during a science window, when the transient source is not active, as an independent temporal off-source observation (see Fig. \ref{fig:lightcurve}). Similar to other instruments, that use spatially off-source observation as an independent background measurement. From the background observations we construct the probability of the background model rates per energy channel from a poisson distribution, like given in equation \ref{eq:poisson_bkg}, where $b_{i}$ are the background rates per energy channel, $B_{i}$ are the detected counts in the off-source observation and $t_{b}$ is the exposure of the off-source observation.
\begin{equation}
	L(b_{i}|B_{i}, t_{b})=\frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b} b_{i}}
  \label{eq:poisson_bkg}
\end{equation}
This expression will be used in the next paragraph to derive the total likelihood.

\begin{figure}
    \begin{centering}
        \includegraphics{figures/lightcurve.pdf}
        \caption{Lightcurve for SPI detector 0 for GRB120711A. The transient source is clearly visible as well as the constant background for the time when the transient is not active.}
        \label{fig:lightcurve}
    \end{centering}
\end{figure}


% add a lightcurve plot?

\subsubsection*{Likelihood}

With the defined background treatment, we can construct a Poisson likelihood with a Poisson measurement of background, like given in \ref{eq:likelihood_m_and_b}. Here $\theta$ summarizes all the parameters of the model, $D_{i}$ are the measured counts in the selected active time interval of the transient source, $m_{i}(\theta)$ are the predicted counts from the model evaluated at the parameters $\theta$ and $t_{d}$ is the exposure of the selected active time interval.

\begin{equation}
	L(\theta, b_{i}|D_{i}, B_{i},t_{d},t_{b}) = \frac{(t_{d}(m_{i}(\theta)+ b_{i}))^{D_{i}}}{D_{i}!}\cdot e^{-t_{d}(m_{i}(\theta)+b_{i})} \frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b} b_{i}}
  \label{eq:likelihood_m_and_b}
\end{equation}

Now we can marginalize over the parameters $b_{i}$, that we are not interested in, which leaves us with equation \ref{eq:likelihood_marg}.

\begin{equation}
	L(\theta|D_{i}, B_{i},t_{d},t_{b}) = \int_{0}^{\infty}\textrm{db}_{i}\frac{(t_{d}(m_{i}(\theta)+ b_{i}))^{D_{i}}}{D_{i}!}\cdot e^{-t_{d}(m_{i}(\theta)+b_{i})} \frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b}b_{i}}
  \label{eq:likelihood_marg}
\end{equation}

Because there is no easy analytical solution for this integral, one often uses a so-called profiled likelihood as an approximation. For the profiled likelihood we use the fact, that the derivative of the likelihood at its maximum is zero. Therefore one can construct from $\frac{\textrm{dL}}{\textrm{db}_i}=0$ the background rates $b_{i, max}$ that maximize the likelihood for a given model $m_{i}(\theta)$ and observed quantities. Solving $\frac{\textrm{dL}}{\textrm{db}_i}=0$ for b gives equation \ref{eq:bmax}.
\begin{equation}
	b_{i,max}(\theta)=\frac{1}{2(t_{b}+t_{d})}(B_{i}+D_{i}-m_{i}(\theta)(t_{b}+t_{d})+\sqrt{(B_{i}+D_{i}+m_{i}(\theta)(t_{b}+t_{d}))^{2}-4m_{i}(\theta)D_{i}(t_{d}-t_{b})}
  \label{eq:bmax}
\end{equation}

These values can then be substituted in the likelihood \ref{eq:likelihood_m_and_b} to eliminate the $b_{i}$ dependency. This approximation gives the exact solution for the maximum of the likelihood, for likelihood values close to the maximum, the assumption is that most of the likelihood in the integrand in \ref{eq:likelihood_marg} is in a small area around $b_{i,max}$. This assumption is used in many spectral analyses and works very well as long as one does not have too few counts in the background observation \footnote{For a derivation see https://giacomov.github.io/Bias-in-profile-poisson-likelihood/}.

\subsubsection*{Response}

To convert a physical spectrum to a detected count spectrum, we need the response for a given source position. The response encapsulates all the information about the probability of a photon with a certain energy and origin to be detected in a certain energy channel of the detector. This includes for example information about partial energy deposition of the photon in the crystal and the process that transforms the deposited energy into an electronic signal, that is measured in the end.
% distribution of how much energy a photon with a certain energy deposit in the crystal and what energy is in the end measured for this deposited energy.
In PySPI we use the official response files for Image Response Functions (IRFs) and Redistribution Matrix Files (RMFs) derived by \citet{spi_response}. The IRF files give the total effective area for three different interaction types:
\begin{itemize}
  \item Photo peak events
  \item Non photo peak events that first interact in the crystal
  \item Non photo peak events that first interact in passive material
\end{itemize}

These effective areas were simulated for 51 photon energies and on a 0.5 degree grid. For each of the three interaction type, there is one RMF, to define the shape of the redistributed spectra, assuming that this shape does not depend on the detector or the incident angles of the photons. The procedure to construct the response includes several simplification to keep the computational costs and storage space manageable \citep{spi_response}. This could of course affect every analysis done with SPI. Re-simulating the response without these simplifications could improve the scientific output of SPI, but would take a hugh amount of computational time, even today.

In PySPI we then interpolate the official response files to the user defined energy bins and source positions.

\subsubsection*{Electronic Noise}

Since shortly after the start of INTEGRAL, it is known that there are spurious events in the SPI data around 1.5 MeV. According to \citet{spi_electronic_noise} these spurious events are photons with small energy (<100 keV) that get detected at a higher energy due to saturation of the Analog Front-End Electronics (AFEE) electronics by previous high energy deposition. It is also known, that these spurious events do not show up if one looks only at events with a detection also in the Pulse Shape Discriminator (PSD) electronics. The reason for this is that the PSD electronics has a low energy threshold of roughly 450 keV (the exact value has been changed a few times during the mission). Therefore only events that deposit more than this low energy threshold in the Germanium crystal can trigger this electronic, which eliminates the <100 keV events that are detected at the wrong energies by the AFEE electronics. In Fig. \ref{fig:electronic} one can see that the feature at 1.5 MeV is nicely visible in the non-PSD events but is missing in the PSD events. Even though this problem is the most significant in the area around 1.5 MeV it is also important at lower energies >400 keV. In PySPI one can select the energy range in which only the PSD events should be used, to avoid including spurious events. To account for the larger dead time of the PSD electronics, an effective area correction can be either fix to 85 \% \citep{spi_electronic_noise} or treated as a free parameter in the fit.

\begin{figure}
    \begin{centering}
        \includegraphics{figures/electronic_noise.pdf}
        \caption{Count spectrum for detector 0 integrated over 1000 seconds. One can clearly see the feature in the Non-PSD events at 1.5 MeV that is not visible in the PSD events.}
        \label{fig:electronic}
    \end{centering}
\end{figure}

\subsubsection*{General Procedure}

In PySPI every Germanium detector is treated as an independent detector. The workflow during a fit step is the following:
\begin{itemize}
  \item Sample model parameters
  \item Calculate model flux and responses individually for all detectors for the source position
  \item Fold model with responses to get predicted model counts in all detectors
  \item Calculate log-likelihood for all detectors
  \item Sum these log-likelihoods to get the total log-likelihood of the SPI data for the given model parameters
\end{itemize}
A sampling algorithm like MultiNest \citep{multinest} is used to iterate this procedure, in order to determine the posterior distributions.\\
This workflow is very similar, like for example for GBM, because fundamentally instruments like SPI and GBM are very similar. They both consist of individual detectors that have different responses for a given source position. In GBM this is due to the different pointing directions of the detectors and in SPI due to the different occultation by the mask. Therefore there is no reason to treat SPI specially, just because it is a coded mask instrument. The information the mask encodes into the data is automatically included by using the different responses for the detectors.

\subsubsection*{3ML plugin}

PySPI can construct a plugin for the Multi-Mission Maximum Likelihood framework (3ML) \citep{3ML}. This allows, without any further work, to fit the SPI data together with the data from other instruments, like Fermi/GBM. \footnote{For more information about 3ML see threeml.readthedocs.io/}

\subsubsection*{Open Source Software}

PySPI is an open source software, which is publicly available on GitHub (cite JOSS). There is also a documentation, that shows how to use it. \footnote{For more information about PySPI see pyspi.readthedocs.io/}


%\bibliographystyle{aasjournal}
%\bibliography{biblio}

\end{document}
