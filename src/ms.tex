% Define document class
\documentclass[twocolumn]{aa}

% Filler text
\usepackage{blindtext}

% Begin!
\begin{document}

% Title
\title{Fitting Synchrotron Models to Gamma Ray Burst data from INTEGRAL/SPI}

% Author list
\author{BjÃ¶rn Biltzinger \inst{mpe}, Jochen Greiner \inst{mpe}, J. Michael Burgess \inst{mpe}, Thomas Siegert \inst{mpe}}
\institute{Max-Planck-Institut fur extraterrestrische Physik, Giessenbachstrasse 1, D-85748 Garching, Germany \label{mpe}}
\date{Received 18 December, 2019; accepted 22 May, 2020}
% Abstract with filler text
\abstract{
  In the last years it has been shown, that it is needed to fit physical models to Gamma-Ray Burst (GRB) data to get more insights into their emission mechanism. For the energy range between ~ 10 keV to ~ 10 MeV Fermi/GBM has been the main instrument.... In this paper we show how we can add INTEGRAL/SPI to this analysis. INTEGRAL/SPI covers a similar energy range like Fermi/GBM and has a very good energy resolution of 2.2 keV at 1.3 MeV. Therefore INTEGRAL/SPI is an ideal instrument to precisely measure the curvature of the spectrum. In this work we present PySPI, a new analysis software we developed to analyze GRB data from SPI, and apply it to the GRB 120711A. We show that the GBM and the SPI data of this GRB can be fitted with a physical synchrotron model and that combining both, reduces the allowed parameter space.
}

\keywords{ (stars:) gamma ray bursts -- methods: data analysis --
  methods: statistical}

\maketitle

% Main body with filler text
\section{Introduction}
Gamma-Ray Bursts (GRBs) are short transient bursts of gamma rays, with a typical active time range between a few ms and few hundred seconds for the prompt phase, which is mostly observed in X- and Gamma-Rays. After the prompt emission there is a long lasting afterglow phase when the ejecta interacts with the Inter Steallar Medium (ISM). Long GRBs ($\approx$> 2s) have been associated to the collapse of massive stars (cite), whereas short GRBs are believed to be caused by mergers of compact objects, like Neutron Stars (cite grb-gw). In both cases is commonly agreed on that the progenitor events of GRBs should produce jetted relativistic outflows, which consists of shells resulting in internal shell collisions. But it is still highly debated what the exact emission mechanism of the Gamma-Rays is.

In the past, GRB data was often fitted with empirical function like the Band function (cite band). But in recent years it has been shown, that this approach can be misleading and that one should rather fit physical models directly to the data. An example for this is the so-called line-of-death for synchrotron emission, which states that synchrotron radiation can not be the emission mechanism, if fits with a Band function give a low energy power law slope larger than -2/3. (cite) have shown that this conclusion is not correct and that you can fit GRB spectral well with a physical synchrotron model even though the same spectra violate the line-of-death if fitted with a Band function.
The Gamma-Ray Burst Monitor (GBM) onboard of the Fermi satellite is often used to fit GRB data in the Gamma-Ray energy range. GBM is an all-sky instrument, that observes the whole sky, except the part that is occulted by the Earth at that time. It consists of 12 NaI and two BGO scintillator detectors that cover in total an energy range between 8 keV and 10 MeV. (cite)
%The problem with fitting empirical models to the data and using the individual parameters of these fits to construct constrains on the physics is that the
Another instrument that operates in a similar energy range The SPectrometer on INTEGRAL (SPI) is one of the instruments onboard of the INTErnational Gamma-Ray Astrophysics Laboratory (INTEGRAL) satellite, that was launched in 2002 and is still operating today. SPI is a coded mask instrument, which has a FOV of roughly ? sr and covers an energy range between 20 keV and 8 MeV. Due to the Germanium detectors it has a very good energy resolution of roughly 2.2 keV at 1.3 MeV, which allows the identification of fine features, like atomic decay lines. (cite) In the case of GRBs this excellent energy resolution could allow us to determine the curvature of the spectra with an unmet precision. This is the main motivation to use SPI in our analysis. Several works have used SPI data to fit GRB models (cite), but all of them fitted empirical models like the Band function. To allow us to fit physical models and to improve the analysis methods we developed PySPI, which will be explained in detail in \ref{pyspi}.

%The other instrument that we use in this work is the Gamma-Ray Burst Monitor (GBM) onboard of the Fermi satellite. GBM is an all-sky instrument, that observes the whole sky, except the part that is occulted by the Earth at that time. It consists of 12 NaI and two BGO scintillator detectors that cover in total an energy range between 8 keV and 10 MeV. (cite)

\section{Methods}
\subsection{PySPI}
\label{pyspi}
To fit the SPI data of GRBs, we developed a new python package PySPI (ref to JOSS?), which is an open source analysis tool. In the following we will summarize the main points of PySPI.

\subsubsection*{Background}

GRBs are transient sources with a typical duration only up to a few tens of seconds.
%Therefore we can use the time before and after the GRB signal, but within the same science window, as a background measurement.
%The background treatment we use, depends on two assumptions, namely that within one science window the background is stable and the pointing direction of SPI does not change.
%Due to the high orbit and pointing scheme of INTEGRAL both these assumptions are valid.
Therefore we can use the time intervals during a science window when the transient source is not active as an independent background measurement. Similar to other instruments that use spatially off-source observation as an independent background measurement. In the case of transients in SPI we have temporal off-source observation (see Fig. \ref{fig:lightcurve}). From the background observations we construct the probability of the background model rates per energy channel from a poisson distribution, like given in equation \ref{eq:poisson_bkg}, where $b_{i}$ are the background rates per energy channel, $B_{i}$ are the detected counts in the off-source observation and $t_{b}$ is the exposure of the off-source observation.
\begin{equation}
	L(b_{i}|B_{i}, t_{b})=\frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b} b_{i}}
  \label{eq:poisson_bkg}
\end{equation}
This will be used in the next paragraph to derive the total likelihood.

\begin{figure}
    \begin{centering}
        \includegraphics{figures/lightcurve.pdf}
        \caption{Lightcurve for SPI detector 0 for GRB120711A. The transient source is clearly visible as well as the constant background for the time when the transient is not active.}
        \label{fig:lightcurve}
    \end{centering}
\end{figure}


% add a lightcurve plot?

\subsubsection*{Likelihood}

With the defined background treatment, we can construct a Poisson likelihood with a Poisson measurement of background, like given in \ref{eq:likelihood_m_and_b}. Here $\theta$ summarizes all the parameters of the model, $D_{i}$ are the measured counts in the selected active time interval of the transient source, $m_{i}(\theta)$ are the predicted counts from the model evaluated at the parameters $\theta$ and $t_{d}$ is the exposure of the selected active time interval.

\begin{equation}
	L(\theta, b_{i}|D_{i}, B_{i},t_{d},t_{b}) = \frac{(t_{d}(m_{i}(\theta)+ b_{i}))^{D_{i}}}{D_{i}!}\cdot e^{-t_{d}(m_{i}(\theta)+b_{i})} \frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b} b_{i}}
  \label{eq:likelihood_m_and_b}
\end{equation}

Now we can marginalize over the parameters $b_{i}$, that we are not interested in, which leaves us with equation \ref{eq:likelihood_marg}.

\begin{equation}
	L(\theta|D_{i}, B_{i},t_{d},t_{b}) = \int_{0}^{\infty}\textrm{db}_{i}\frac{(t_{d}(m_{i}(\theta)+ b_{i}))^{D_{i}}}{D_{i}!}\cdot e^{-t_{d}(m_{i}(\theta)+b_{i})} \frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b}b_{i}}
  \label{eq:likelihood_marg}
\end{equation}

Because there is no easy analytical solution for this integral, one often uses a so-called profiled likelihood as an approximation. For the profiled likelihood we use the fact, that the derivative of the likelihood at its maximum should be zero. Therefore one can construct from $\frac{\textrm{dL}}{\textrm{db}_i}=0$ the background rates $b_{i, max}$ that maximize the likelihood for a given model $m(\theta)_{i}$ and observed counts. Solving $\frac{\textrm{dL}}{\textrm{db}_i}=0$ for b gives equation \ref{eq:bmax}.
\begin{equation}
	b_{i,max}(\theta)=\frac{1}{2(t_{b}+t_{d})}(B_{i}+D_{i}-m_{i}(\theta)(t_{b}+t_{d})+\sqrt{(B_{i}+D_{i}+m_{i}(\theta)(t_{b}+t_{d}))^{2}-4m_{i}(\theta)D_{i}(t_{d}-t_{b})}
  \label{eq:bmax}
\end{equation}

These values can then be substituted in the likelihood \ref{eq:likelihood_m_and_b} to eliminate the $b_{i}$ dependency. This approximation gives the exact solution for the maximum of the likelihood, for likelihood values close to the maximum the assumption is that most of the likelihood in the integrand in \ref{eq:likelihood_marg} is in a small area around $b_{i,max}$ and we can add a $\delta(b_{i}-b_{{i,max}})$. This assumption is used in many works (cite) and works very well as long as one does not have too few counts in the background observation (for a derivation see cite Giacomo derivation).

\subsubsection*{Response}

To convert a physical spectrum to a detected count spectrum, we need the response for a given source position. The response encapsulates all the information about the probability of a photon with a certain energy and origin to be detected in a certain energy channel of the detector. This includes for example information about partial energy deposition of the photon in the crystal and the process that transforms the deposited energy into an electronic signal, that SPI measures.
% distribution of how much energy a photon with a certain energy deposit in the crystal and what energy is in the end measured for this deposited energy.
In PySPI we use the official response files for Image Response Functions (IRFs) and Redistribution Matrix Files (RMFs) derived by Sturner 2003 (cite). The IRF files give the total effective area for three different interaction types:
\begin{itemize}
  \item Photo peak events
  \item Non photo peak events that first interact in the crystal
  \item Non photo peak events that first interact in passive material
\end{itemize}

These effective areas were calculated for 51 photon energies and on a 0.5 degree grid. For each of the three interaction type there is one RMF, to define the shape of the redistributed spectra, assuming that this shape does not depend on the detector or the incident angles of the photons.
The procedure to construct the response includes several simplification to keep the computational costs and storage space manageable (cite). This could of course affect every analysis done with SPI. Re-simulating the response without these simplifications could improve the scientific output of SPI, but would take a hugh amount of computational time, even today.

In PySPI we then interpolate the official response files to the user defined energy bins.

\subsubsection*{Electronic Noise}

Since shortly after the start of INTEGRAL, it is known that there are spurious events in the SPI data around 1.5 MeV. According to Roques (cite) these spurious events are photons with small energy (<100 keV) that get detected at a higher energy due to saturation of the ??? electronics by previous high energy deposition. It is also known, that these spurious events do not show up if one looks only at events with a detection also in the Pulse Shape Discriminator (PSD) electronics. This is because the PSD electronics has an low energy threshold of roughly 450 keV (the exact value has been changed a few times during the mission). Therefore only events that deposit more than this low energy threshold in the Germanium crystal can trigger this electronic, which eliminates the <100 keV events that are detected at the wrong energies by the AFEE electronics. In Fig. \ref{fig:electronic} one can see that the feature at 1.5 MeV in the non-PSD events is nicely visible and is missing in the PSD events. Even though this problem is the most significant in the area around 1.5 MeV it is also important at lower energies >400 keV.


\begin{figure}
    \begin{centering}
        \includegraphics{figures/electronic_noise.pdf}
        \caption{Count spectrum for detector 0 integrated over 1000 seconds. One can clearly see the feature in the Non-PSD events at 1.5 MeV that is not visible in the PSD events.}
        \label{fig:electronic}
    \end{centering}
\end{figure}

\subsubsection*{General Procedure}

In PySPI every Germanium detector is treated as an independent detector. The workflow during a fit is the following:
\begin{itemize}
  \item Sample model parameters
  \item Calculate model flux and Responses individually for all detectors for the source position
  \item Fold model with responses to get predicted model counts in all detectors
  \item Calculate log-likelihood for all detectors
  \item Sum these log-likelihoods to get the total log-likelihood of SPI
\end{itemize}
Then a sampling algorithm like emcee (cite) or multinest (cite) is used to iterate this procedure, in order to determine the posterior distributions.\\
This workflow is very similar, like for example for Fermi/GBM, because fundamentally instruments like INTEGRAL/SPI and Fermi/GBM are very similar. They both consist of individual detectors that have different responses for a given source position. In GBM this is due to the different pointing directions of the detectors and in SPI due to the different occultation by the mask. Therefore there is no reason to treat SPI specially, just because it is a coded mask instrument. The information the mask encodes into the data is automatically included by using the different responses for the detectors.

\subsubsection*{3ML plugin}

PySPI can construct a plugin for the Multi-Mission Maximum Likelihood framework (3ML). This allows without any further work to fit the SPI data together with the data from other instruments, like Fermi/GBM. For more informations about 3ML see (cite paper and documentation).

\subsubsection*{Open Source Software}

PySPI is an open source software, which is publicly available on GitHub. There is also a documentation, that shows how to use PySPI for other GRBs as well. (cite JOSS, link to repo, docs).

\subsection{OSA}
\label{OSA}

As we are introducing a new analysis software in this work, we want to compare it to the existing analysis software, to check if the results are in agreement. Therefor we shortly summarize the official analysis tools for GRB analysis, which are part of the INTEGRAL Offline Scientific Analysis (OSA) software, here.

Analyzing GRB data from SPI with the OSA tools is a multi step process. The first steps are selecting the science window with the GRB, the time intervals for active time and background time as well as the energy bins for the analysis. After that one can either find the location of the GRB with SPIROS or set it manually, if it is already known. The next steps concern the spectral fitting, which is done in a two step procedure, which will be called Photo Peak Fitting and Energy Redistribution Fitting hereafter.

\subsubsection*{Photo Peak Fitting}

The first step in the spectral fitting with OSA is to use only the photo peak response of the detectors. These responses depend on the source position, as this defines the absorption by the mask. With these responses and the different measured data in the individual SPI detectors, taking into account

\subsection{Synchrotron Model}

We use pynchrotron (cite github) to calculate the spectrum from a physical, time dependent spectral model. This model was previously used to successfully fit many single pulse GRBs with GBM in cite syn paper. This paper also include a detailed description of the model. Here we only want to summarize the main points shortly.

The core of the model is the assumption of some generic acceleration mechanism, that constantly produces an electron spectrum with a power law shape $N(\gamma )\propto gamma^{-p}$ between $\gamma_{inj}$ and $\gamma_{max}$. These electrons are cooled via synchrotron cooling in a magnetic field and produce radiation in this process. The resulting photon spectrum is defined by five quantities:

\begin{enumerate}
	\item Magnetic field strength $B$
  \item Lower boundary of the injected electron spectrum $\gamma_{inj}$
  \item Upper boundary of the injected electron spectrum $\gamma_{max}$
  \item Slope of the injected electron spectrum $p$
  \item Characteristic Lorentz factor the electrons cool to $\gamma_{cool}$
\end{enumerate}

For more details about the model check (cite Syn paper).

\subsection{Model Checking}
\label{PPC}
To check if the fit of a model is a good description of the measured data is a very complicated topic and highly debated in the statistics community. Measurements like reduced $\chi^{2}$ assume that all the probability distributions in the problem are described as normal distributions, which is definitely not the case here, as for example the measurement process is a Poisson process. Therefore we decided to use Posterior Predictive Checks (PPCs), which use the posterior of the fit as well as the measurement process to simulate new data.

\begin{equation}
  \textrm{P}(y^{\textrm{sim}}|y^{\textrm{obs}}) = \int \textrm{P}(y^{\textrm{sim}}|\theta) \textrm{P}(\theta|y^{\textrm{obs}}) \mathrm{d}\theta
\end{equation}
\noindent
Here $y^{\textrm{obs}}$ are the observed data, $\textrm{P}(\theta|y^{\textrm{obs}})$ is the posterior distribution of the model parameters $\theta$ given the observed data, $\textrm{P}(y^{\textrm{sim}}|\theta)$ is the probability of new data given the parameters of the model and $y^{\textrm{sim}}$ are the simulated data. These simulated data are then compared to the observed data and allow for a visual check, whether the fit results together with the measuring process can reproduce the data. (cite paper for this)
\section{Analysis}

In this work we analyze GRB 120711A, which was a multi bright pulse GRB with a precursor and a long emission period of $\approx$100 seconds. It was detected by SPI and GBM. In this work we only look at one time slice with a duration of 10 seconds around the highest peak in the light curves (add light curve plot with SPI and GBM data).

First we analyze the data from the two instruments independently with empirical and physical models, to check if the results for SPI and GBM are in agreement and show a comparison between the fit results with PySPI and the official software tools for GRB analysis within OSA. After that we fit the data simultaneously, to show that it can reduce the allowed parameter space significantly.

All the fits in this section are done with 3ML and the Bayesian sampler algorithm MultiNest (cite) to create full posterior distributions.

\subsection{Compare PySPI and OSA}

We analyze the SPI data for the same time interval with PySPI and OSA, to check if the results are in agreement. The two methods are described in \ref{OSA} and \ref{pyspi}. This is done for a fit with an empirical model (Band function) and a fit with the physical synchrotron model. The resulting posterior distributions, displayed as corner plots, and the PPC plots (see \ref{PPC}) are shown in Fig. ? - Fig. ?. The posterior distributions show, that the results from the two analysis techniques are in agreement, but PySPI can constrain the parameters much better.

(include figs for band function and syn. fits!)

\subsection{Compare SPI and GBM}

Next, we analyze the SPI data with PySPI and the GBM data with the GRB analysis within 3ML (cite a paper for this?). Again we do this for an empirical model and the physical synchrotron model. The fit results are shown in Fig. ? - Fig. ?.


\subsection{Joint Fit of SPI and GBM}

The final analysis is a joint fit with SPI and GBM. This

\section{Conclusion}

- Possible to fit physical models to GRB data of SPI and get same parameters as GBM
- Combined fits reduce available parameter space
- PySPI can be used to fit all SPI GRBs in the future with different physical models to help distinguishing between them

\end{document}
