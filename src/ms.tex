% Define document class
\documentclass[twocolumn]{aa}

% Filler text
\usepackage{caption}
\usepackage{subcaption}
% Begin!
\begin{document}

% Title
\title{Fitting Synchrotron Models to Gamma-Ray Burst Data from INTEGRAL/SPI}

% Author list
\author{
  BjÃ¶rn Biltzinger
  \and
  Jochen Greiner
  \and
  Michael Burgess
  \and
  Siegert
}

\institute{Max-Planck-Institut fur extraterrestrische Physik, Giessenbachstrasse 1, D-85748 Garching, Germany \label{mpe}}
\date{Received 18 December, 2019; accepted 22 May, 2020}

\label{firstpage}
% Abstract with filler text
\abstract {
  In the last years it has been shown, that it is needed to fit physical models to Gamma-Ray Burst (GRB) data to get more insights into their emission mechanism. For the energy range between ~ 10 keV to ~ 10 MeV Fermi/GBM has been the main instrument.... In this paper we show how we can add INTEGRAL/SPI to this analysis. INTEGRAL/SPI covers a similar energy range like Fermi/GBM and has a very good energy resolution of 2.2 keV at 1.3 MeV. Therefore INTEGRAL/SPI is an ideal instrument to precisely measure the curvature of the spectrum. In this work we present PySPI, a new analysis software we developed to analyze GRB data from SPI, and apply it to the GRB 120711A. We show that PySPI improves the analysis of SPI data, for GRBs, compared to the official analysis software. Also we show that the GBM and the SPI data of this GRB can be fitted well with a physical synchrotron model and that combining both, reduces the allowed parameter space.
}

\keywords{ (stars:) gamma ray bursts -- methods: data analysis --
  methods: statistical}

\maketitle

% Main body with filler text
\section{Introduction}

Gamma-Ray Bursts (GRBs) are short transient bursts of gamma rays, with a typical active time range between a few ms and few hundred seconds for the prompt phase, which is mostly observed in X- and Gamma-Rays. After the prompt emission there is a long lasting afterglow phase when the ejecta interacts with the Inter Stellar Medium (ISM). Long GRBs ($\approx$> 2s) have been associated to the collapse of massive stars (cite), whereas short GRBs are believed to be caused by mergers of compact objects, like Neutron Stars (cite grb-gw). In both cases it is commonly agreed on, that the progenitor events of GRBs produce jetted relativistic outflows, which consists of several shells with different velocities, resulting in internal shell collisions. But it is still highly debated what the exact emission mechanism of the Gamma-Rays is.

In the past, GRB data was often fitted with empirical function like the Band function (cite band). But in recent years it has been shown, that this approach can be misleading and that one should rather fit physical models directly to the data. An example for this is the so-called line-of-death for synchrotron emission, which states that synchrotron radiation can not be the emission mechanism, if fits with a Band function give a low energy power law slope larger than -2/3. (cite) have shown that this conclusion is not correct and that you can fit GRB spectra well with a physical synchrotron model even though the same spectra violate the line-of-death if fitted with a Band function.
The Gamma-Ray Burst Monitor (GBM) onboard of the Fermi satellite is often used to fit GRB data in the Gamma-Ray energy range. GBM is an all-sky instrument, that observes the whole sky, except the part that is occulted by the Earth at that time. It consists of 12 NaI and two BGO scintillator detectors that cover in total an energy range between 8 keV and 10 MeV. (cite)
%The problem with fitting empirical models to the data and using the individual parameters of these fits to construct constrains on the physics is that the
Another instrument that operates in a similar energy range is the SPectrometer on INTEGRAL (SPI), which is one of the instruments onboard of the INTErnational Gamma-Ray Astrophysics Laboratory (INTEGRAL) satellite, that was launched in 2002 and is still operating today. SPI is a coded mask instrument, which has a FOV of roughly ? sr and covers an energy range between 20 keV and 8 MeV. Due to the Germanium detectors it has a very good energy resolution of roughly 2.2 keV at 1.3 MeV, which allows the identification of fine features, like atomic decay lines. (cite) In the case of GRBs this excellent energy resolution could allow us to determine the curvature of the spectra with an unmet precision. This is the main motivation to use SPI in our analysis.

Several works have used SPI data to fit GRB models (cite), but all of them fitted empirical models like the Band function. To allow us to fit physical models and to improve the analysis methods we developed PySPI, which will be explained in detail in \ref{pyspi}.

%The other instrument that we use in this work is the Gamma-Ray Burst Monitor (GBM) onboard of the Fermi satellite. GBM is an all-sky instrument, that observes the whole sky, except the part that is occulted by the Earth at that time. It consists of 12 NaI and two BGO scintillator detectors that cover in total an energy range between 8 keV and 10 MeV. (cite)

\section{Methods}
\subsection{PySPI}
\label{pyspi}
To fit the SPI data of GRBs, we developed a new python package PySPI (ref to JOSS?), which is an open source analysis tool. In the following we will summarize the main points of PySPI.

\subsubsection*{Background}

GRBs are transient sources with a typical duration only up to a few tens of seconds.
%Therefore we can use the time before and after the GRB signal, but within the same science window, as a background measurement.
%The background treatment we use, depends on two assumptions, namely that within one science window the background is stable and the pointing direction of SPI does not change.
%Due to the high orbit and pointing scheme of INTEGRAL both these assumptions are valid.
Therefore we can use the time intervals during a science window when the transient source is not active as an independent temporal off-source observation (see Fig. \ref{fig:lightcurve}). Similar to other instruments that use spatially off-source observation as an independent background measurement. From the background observations we construct the probability of the background model rates per energy channel from a poisson distribution, like given in equation \ref{eq:poisson_bkg}, where $b_{i}$ are the background rates per energy channel, $B_{i}$ are the detected counts in the off-source observation and $t_{b}$ is the exposure of the off-source observation.
\begin{equation}
	L(b_{i}|B_{i}, t_{b})=\frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b} b_{i}}
  \label{eq:poisson_bkg}
\end{equation}
This expression will be used in the next paragraph to derive the total likelihood.

\begin{figure}
    \begin{centering}
        \includegraphics{figures/lightcurve.pdf}
        \caption{Lightcurve for SPI detector 0 for GRB120711A. The transient source is clearly visible as well as the constant background for the time when the transient is not active.}
        \label{fig:lightcurve}
    \end{centering}
\end{figure}


% add a lightcurve plot?

\subsubsection*{Likelihood}

With the defined background treatment, we can construct a Poisson likelihood with a Poisson measurement of background, like given in \ref{eq:likelihood_m_and_b}. Here $\theta$ summarizes all the parameters of the model, $D_{i}$ are the measured counts in the selected active time interval of the transient source, $m_{i}(\theta)$ are the predicted counts from the model evaluated at the parameters $\theta$ and $t_{d}$ is the exposure of the selected active time interval.

\begin{equation}
	L(\theta, b_{i}|D_{i}, B_{i},t_{d},t_{b}) = \frac{(t_{d}(m_{i}(\theta)+ b_{i}))^{D_{i}}}{D_{i}!}\cdot e^{-t_{d}(m_{i}(\theta)+b_{i})} \frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b} b_{i}}
  \label{eq:likelihood_m_and_b}
\end{equation}

Now we can marginalize over the parameters $b_{i}$, that we are not interested in, which leaves us with equation \ref{eq:likelihood_marg}.

\begin{equation}
	L(\theta|D_{i}, B_{i},t_{d},t_{b}) = \int_{0}^{\infty}\textrm{db}_{i}\frac{(t_{d}(m_{i}(\theta)+ b_{i}))^{D_{i}}}{D_{i}!}\cdot e^{-t_{d}(m_{i}(\theta)+b_{i})} \frac{(t_{b} b_{i})^{B_{i}}}{B_{i}!}\cdot e^{-t_{b}b_{i}}
  \label{eq:likelihood_marg}
\end{equation}

Because there is no easy analytical solution for this integral, one often uses a so-called profiled likelihood as an approximation. For the profiled likelihood we use the fact, that the derivative of the likelihood at its maximum is zero. Therefore one can construct from $\frac{\textrm{dL}}{\textrm{db}_i}=0$ the background rates $b_{i, max}$ that maximize the likelihood for a given model $m_{i}(\theta)$ and observed counts. Solving $\frac{\textrm{dL}}{\textrm{db}_i}=0$ for b gives equation \ref{eq:bmax}.
\begin{equation}
	b_{i,max}(\theta)=\frac{1}{2(t_{b}+t_{d})}(B_{i}+D_{i}-m_{i}(\theta)(t_{b}+t_{d})+\sqrt{(B_{i}+D_{i}+m_{i}(\theta)(t_{b}+t_{d}))^{2}-4m_{i}(\theta)D_{i}(t_{d}-t_{b})}
  \label{eq:bmax}
\end{equation}

These values can then be substituted in the likelihood \ref{eq:likelihood_m_and_b} to eliminate the $b_{i}$ dependency. This approximation gives the exact solution for the maximum of the likelihood, for likelihood values close to the maximum the assumption is that most of the likelihood in the integrand in \ref{eq:likelihood_marg} is in a small area around $b_{i,max}$ and we can basically add a $\delta(b_{i}-b_{{i,max}})$. This assumption is used in many works (cite) and works very well as long as one does not have too few counts in the background observation (for a derivation see cite Giacomo derivation).

\subsubsection*{Response}

To convert a physical spectrum to a detected count spectrum, we need the response for a given source position. The response encapsulates all the information about the probability of a photon with a certain energy and origin to be detected in a certain energy channel of the detector. This includes for example information about partial energy deposition of the photon in the crystal and the process that transforms the deposited energy into an electronic signal, that is measured in the end.
% distribution of how much energy a photon with a certain energy deposit in the crystal and what energy is in the end measured for this deposited energy.
In PySPI we use the official response files for Image Response Functions (IRFs) and Redistribution Matrix Files (RMFs) derived by Sturner 2003 (cite). The IRF files give the total effective area for three different interaction types:
\begin{itemize}
  \item Photo peak events
  \item Non photo peak events that first interact in the crystal
  \item Non photo peak events that first interact in passive material
\end{itemize}

These effective areas were calculated for 51 photon energies and on a 0.5 degree grid. For each of the three interaction type there is one RMF, to define the shape of the redistributed spectra, assuming that this shape does not depend on the detector or the incident angles of the photons.
The procedure to construct the response includes several simplification to keep the computational costs and storage space manageable (cite). This could of course affect every analysis done with SPI. Re-simulating the response without these simplifications could improve the scientific output of SPI, but would take a hugh amount of computational time, even today.

In PySPI we then interpolate the official response files to the user defined energy bins and source positions.

\subsubsection*{Electronic Noise}

Since shortly after the start of INTEGRAL, it is known that there are spurious events in the SPI data around 1.5 MeV. According to (cite Roques) these spurious events are photons with small energy (<100 keV) that get detected at a higher energy due to saturation of the ??? electronics by previous high energy deposition. It is also known, that these spurious events do not show up if one looks only at events with a detection also in the Pulse Shape Discriminator (PSD) electronics. The reason for this is that the PSD electronics has an low energy threshold of roughly 450 keV (the exact value has been changed a few times during the mission). Therefore only events that deposit more than this low energy threshold in the Germanium crystal can trigger this electronic, which eliminates the <100 keV events that are detected at the wrong energies by the AFEE electronics. In Fig. \ref{fig:electronic} one can see that the feature at 1.5 MeV is nicely visible in the non-PSD events but is missing in the PSD events. Even though this problem is the most significant in the area around 1.5 MeV it is also important at lower energies >400 keV. In PySPI one can select the energy range in which only the PSD events should be used, to avoid including spurious events. To account for the larger dead time of the PSD electronics, an effective area correction can be either fix to 85 \% (cite) or treated as a free parameter in the fit.

\begin{figure}
    \begin{centering}
        \includegraphics{figures/electronic_noise.pdf}
        \caption{Count spectrum for detector 0 integrated over 1000 seconds. One can clearly see the feature in the Non-PSD events at 1.5 MeV that is not visible in the PSD events.}
        \label{fig:electronic}
    \end{centering}
\end{figure}

\subsubsection*{General Procedure}

In PySPI every Germanium detector is treated as an independent detector. The workflow during a fit step is the following:
\begin{itemize}
  \item Sample model parameters
  \item Calculate model flux and responses individually for all detectors for the source position
  \item Fold model with responses to get predicted model counts in all detectors
  \item Calculate log-likelihood for all detectors
  \item Sum these log-likelihoods to get the total log-likelihood of SPI
\end{itemize}
A sampling algorithm like emcee (cite) or MultiNest (cite) is used to iterate this procedure, in order to determine the posterior distributions.\\
This workflow is very similar, like for example for GBM, because fundamentally instruments like SPI and GBM are very similar. They both consist of individual detectors that have different responses for a given source position. In GBM this is due to the different pointing directions of the detectors and in SPI due to the different occultation by the mask. Therefore there is no reason to treat SPI specially, just because it is a coded mask instrument. The information the mask encodes into the data is automatically included by using the different responses for the detectors.

\subsubsection*{3ML plugin}

PySPI can construct a plugin for the Multi-Mission Maximum Likelihood framework (3ML). This allows, without any further work, to fit the SPI data together with the data from other instruments, like Fermi/GBM. For more information about 3ML see (cite paper and documentation).

\subsubsection*{Open Source Software}

PySPI is an open source software, which is publicly available on GitHub. There is also a documentation, that shows how to use it. (cite JOSS, link to repo, docs).

\subsection{OSA}
\label{OSA}

As we are introducing a new analysis software in this work, we want to compare it to the existing analysis software, to check if the results are in agreement. We shortly summarize the official analysis tools for GRB analysis, which are part of the INTEGRAL Offline Scientific Analysis (OSA) software. (https://ui.adsabs.harvard.edu/abs/2003A%26A...411L..53C/abstract)

Analyzing GRB data from SPI with the OSA tools is a multistep process. The first steps are basic and cover selecting the science window with the GRB, the time intervals for active time and background time as well as the energy bins for the analysis. After that one can either find the location of the GRB with SPIROS, i.e. an iterative source removal algorithm for SPI data, or set it manually, if it is already known. The next steps concern the spectral fitting, which is done in an other two-step procedure, which will be called 'Photo Peak Fitting' and 'Energy Redistribution Fitting' hereafter.

\subsubsection*{Photo Peak Fitting}

The first step in the spectral fitting with OSA is to use only the photo peak response of the detectors. These responses depend on the source position, as this defines for example the absorption by the mask. With these responses and the measured data in the individual SPI detectors, taking into account the different background rates, a photon flux is fitted individually per energy channel. These pseudo photon fluxes are not the final result, as up to this point energy dispersion and detector energy resolution was ignored.

\subsubsection*{Energy Redistribution Fitting}

The pseudo photon flux data points from the 'Photo Peak Fitting' step, which are no real data points anymore, are fitted with a spectral photon flux model which is convolved with a correction response, which is also available through OSA. This correction response depends on the source position and energy bins that are used and should account for energy dispersion as well as resolution. In this step the energy channels are fitted simultaneously, as it is impossible to incorporate energy dispersion in a way that fits every energy channel individually. This fitting can be done in different spectral fitting software like 3ML or XSPEC. In this work we always used 3ML.

\subsection{Synchrotron Model}
\label{synch}
We use pynchrotron (cite github) to calculate the spectrum from a physical, time dependent spectral synchrotron model. This model was previously used to successfully fit many single pulse GRBs with GBM in cite syn paper. This paper also include a detailed description of the model. Here we only want to summarize the main points shortly.

The core of the model is the assumption of some generic acceleration mechanism, that constantly produces an electron spectrum with a power law shape $N(\gamma )\propto gamma^{-p}$ between $\gamma_{inj}$ and $\gamma_{max}$. These electrons are cooled via synchrotron cooling in a magnetic field and produce radiation in this process. The resulting photon spectrum is the sum of the photon spectra at every time step in the cooling process and is defined by five quantities:

\begin{enumerate}
	\item Magnetic field strength $B$
  \item Lower boundary of the injected electron spectrum $\gamma_{inj}$
  \item Upper boundary of the injected electron spectrum $\gamma_{max}$
  \item Slope of the injected electron spectrum $p$
  \item Characteristic Lorentz factor the electrons cool to $\gamma_{cool}$
\end{enumerate}

There exists a strong degeneracy between $B$ and $\gamma_{inj}$, as their combination sets the peak of the photon spectrum. Therefore one usually fixes $\gamma_{inj}=10^{5}$ and only fits for $B$. It is important to keep in mind, that the results for $\gamma_{max}$ and $\gamma_{cool}$ are determined relative to the fixed $\gamma_{inj}$. For more details about the model check (cite Syn paper).

\subsection{Model Checking}
\label{PPC}
To check if the fit of a model is a good description of the measured data is a very complicated topic and highly debated in the statistics community. Measurements like reduced $\chi^{2}$ use many assumptions, like for example that all the probability distributions in the problem are described as normal distributions, which is definitely not the case here, as the measurement process is a Poisson process. Therefore we decided to use Posterior Predictive Checks (PPCs, see Eq. \ref{eq:ppc}), which use the full posterior of the fit as well as the measurement process to simulate new data and compare them to the observed data.

\begin{equation}
  \textrm{P}(y^{\textrm{sim}}|y^{\textrm{obs}}) = \int \textrm{P}(y^{\textrm{sim}}|\theta) \textrm{P}(\theta|y^{\textrm{obs}}) \mathrm{d}\theta
  \label{eq:ppc}
\end{equation}
\noindent
Here $y^{\textrm{obs}}$ are the observed data, $\textrm{P}(\theta|y^{\textrm{obs}})$ is the posterior distribution of the model parameters $\theta$ given the observed data, $\textrm{P}(y^{\textrm{sim}}|\theta)$ is the probability of new data given the parameters of the model and $y^{\textrm{sim}}$ are the simulated data. These simulated data are then compared to the observed data and allow for a visual check, whether the posterior distributions of the fit together with the measuring process can reproduce the data. (cite paper for this)
\section{Analysis}

In this work we analyze GRB 120711A, which was a bright, multi pulse GRB with a precursor and a long emission period of $\approx$100 seconds. It was detected with SPI and GBM. We only look at one time slice with a duration of 10 seconds around the highest peak in the light curves (see Fig. \ref{fig:time_selection}).

\begin{figure}
  \begin{centering}
    \includegraphics[width=1\linewidth]{figures/spi_lightcurve_ts.pdf}
    \includegraphics[width=1\linewidth]{figures/gbm_lightcurve_ts.pdf}
    \label{fig:time_selection}
    \caption{Light curve for GRB120711A.}
  \end{centering}
\end{figure}


We analyze the data from the two instruments independently first with the empirical Band function, to check if the results for SPI and GBM are in agreement as well as show a comparison between the fit results with PySPI and the official software tools for GRB analysis within OSA. Then we fit the SPI and GBM data simultaneously with a physical synchrotron model, and show that it can reduce the allowed parameter space significantly, compared to the individual fits.

All the fits in this section are done with 3ML (cite) and the Bayesian sampler algorithm MultiNest (cite) to create full posterior distributions of the parameters. To visualize the posterior distribution we use ChainConsumer (cite) with the output from MultiNest to create corner plots.

\subsection{Compare PySPI and OSA}

We analyze the SPI data with a band function as spectral model for the same time interval with PySPI and OSA, to check if the results are in agreement. The two methods are described in \ref{OSA} and \ref{pyspi}. Fig. \ref{fig:corner_osa_pyspi_band} shows the resulting posterior distributions of the fits, displayed as a corner plot. The results for the spectral shape from the two analysis techniques agree within their uncertainty region, but PySPI can constrain the parameters more precise.

\begin{figure}
  \begin{centering}
    \includegraphics[width=1\linewidth]{figures/pyspi_vs_osa_band.pdf}
    \label{fig:corner_osa_pyspi_band}
    \caption{Corner plot for the SPI fit with PySPI and the official tools. The spectral model in this fit is a band function. It shows, that the results are in agreement, but PySPI can constrain the parameters better.}
  \end{centering}
\end{figure}


\subsection{Compare SPI and GBM}

Next, we analyze the SPI data with PySPI and the GBM data with the GRB analysis within 3ML (cite a paper for this?) for a band function model. Fig. \ref{fig:corner_gbm_pyspi_band} displays the corner plots for these fits, demonstrating that the results for the spectral shape from SPI and GBM are in agreement. It also shows that the calibration for SPI and GBM are well aligned within only $\approx$ 10\% difference in this case.

\begin{figure}
  \begin{centering}
    \includegraphics[width=1\linewidth]{figures/pyspi_vs_gbm_band.pdf}
    \label{fig:corner_gbm_pyspi_band}
    \caption{Corner plot for the SPI fit with PySPI and the GBM fit. In this fit we used a Band function as spectral model. The spectral shape for the SPI and GBM fits coincide within their uncertainty regions and the normalization is off by $\approx$10\%, which is within the usual calibration offsets of Gamma-Ray space telescopes.}
  \end{centering}
\end{figure}

\subsection{Joint Fit of SPI and GBM}

The final analysis is a joint fit for the SPI and the GBM data with a physical synchrotron model (see \ref{synch}). Fig. \ref{fig:corner_gbm_pyspi_joined_syn} shows the corner plots for the individual and the combined fits. The posterior distribution of the parameters from the GBM and the SPI fit agree within their uncertainty regions and the combined fit reduces the allowed parameter space. The physical synchrotron model was able to fit the data of GBM and SPI well, which is shown with PPC and QQ plots in \ref{appendix}.

\begin{figure}
  \begin{centering}
    \includegraphics[width=1\linewidth]{figures/pyspi_and_gbm_syn.pdf}
    \label{fig:corner_gbm_pyspi_joined_syn}
    \caption{Corner plot for the SPI fit with PySPI and the GBM fit. In this fit we used a physical synchrotron model (see \ref{synch}) as spectral model. The results from SPI and GBM agree within their uncertainty region and the combined fit constrains the parameter better than the individual ones.}
  \end{centering}
\end{figure}

\section{Conclusion}

We analyzed the data of GRB120711A with the data from INTGRAL/SPI and Fermi/GBM. The results for SPI with PySPI are in agreement with those from the official analysis software, but more constraining. Also the resulting spectral shape for the fits with GBM and SPI data are in agreement and the relative calibration difference between SPI and GBM we construct from the fits is $\approx$ 10\% or less. We show that the GBM as well as the SPI data for GRB120711A can be fitted well with a physical, time dependent synchrotron model and that combining the data in a simultaneous fit improve the parameter constrains.

Generally PySPI can improves the scientific output from SPI for GRBs significantly. Due to a new analysis method, that folds the source model directly into the data space of every SPI detector with the full response of the individual detectors, the results are more constraining than the results with the official analysis software.

\begin{appendix}
  \section{Model Checking Plots}
  \label{appendix1}
  In this section we show a selection of the PPC- and QQ-plots for the simultaneous synchrotron fit to the SPI and GBM data for GRB120711A.
  \begin{figure}
    \begin{centering}
      \includegraphics[width=0.45\linewidth]{figures/n0_ppc.pdf}
      \includegraphics[width=0.45\linewidth]{figures/n0_qq.pdf}
      \label{fig:n0_model_check}
      \caption{PPC (left) and QQ (right) plot for the GBM detector n0.}
    \end{centering}
  \end{figure}
  \begin{figure}
    \begin{centering}
      \includegraphics[width=0.45\linewidth]{figures/b0_qq.pdf}
      \includegraphics[width=0.45\linewidth]{figures/b0_qq.pdf}
      \label{fig:b0_model_check}
      \caption{PPC (left) and QQ (right) plot for the GBM detector b0.}
    \end{centering}
  \end{figure}
  \begin{figure}
    \begin{centering}
      \includegraphics[width=0.45\linewidth]{figures/low_13_ppc.pdf}
      \includegraphics[width=0.45\linewidth]{figures/low_13_qq.pdf}
      \label{fig:low_13_model_check}
      \caption{PPC (left) and QQ (right) plot for the low energy range of SPI detector 13 (all single events).}
    \end{centering}
  \end{figure}
  \begin{figure}
    \begin{centering}
      \includegraphics[width=0.45\linewidth]{figures/psd_13_ppc.pdf}
      \includegraphics[width=0.45\linewidth]{figures/psd_13_qq.pdf}
      \label{fig:psd_13_model_check}
      \caption{PPC (left) and QQ (right) plot for the middle energy range of SPI detector 13 (only PSD events).}
    \end{centering}
  \end{figure}
\end{appendix}
\end{document}
